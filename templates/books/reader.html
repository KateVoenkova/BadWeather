{% extends "base.html" %}

{% block title %}Чтение книги{% endblock %}

{% block content %}
<div class="reader-container">
    <!-- Основной контент книги -->
    <div id="book-content" class="book-content white-theme">
        <div class="content-wrapper">
            {% for page in pages %}
            <div class="page{% if loop.index == current_page %} active-page{% endif %}">
                {{ page|safe }}
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Панель настроек -->
    <div id="settings-panel" class="settings-panel">
        <div class="settings-header">
            <h5>Настройки чтения</h5>
            <button id="close-settings" class="btn-close"></button>
        </div>

        <div class="settings-section">
            <h6>Управление</h6>
            <div class="settings-option">
                <span>Прокрутка текста</span>
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="scroll-mode" checked>
                </div>
            </div>
        </div>

        <div class="settings-section">
            <h6>Вид</h6>
            <div class="settings-option">
                <span>Цвет фона</span>
                <div class="theme-selector">
                    <button class="theme-btn white active" data-theme="white"></button>
                    <button class="theme-btn sepia" data-theme="sepia"></button>
                    <button class="theme-btn gray" data-theme="gray"></button>
                    <button class="theme-btn black" data-theme="black"></button>
                </div>
            </div>

            <div class="settings-option">
                <span>Яркость</span>
                <input type="range" class="form-range brightness-slider" min="10" max="100" value="100">
            </div>

            <div class="settings-option">
                <span>Шрифт</span>
                <select class="form-select font-select">
                    <option value="Arial">Arial</option>
                    <option value="Georgia">Georgia</option>
                    <option value="Times New Roman">Times New Roman</option>
                    <option value="Verdana">Verdana</option>
                </select>
            </div>

            <div class="settings-option">
                <span>Размер шрифта</span>
                <div class="font-size-controls">
                    <button class="btn btn-sm btn-outline-secondary decrease-font">A-</button>
                    <span class="font-size-value">16px</span>
                    <button class="btn btn-sm btn-outline-secondary increase-font">A+</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Кнопка открытия настроек -->
    <button id="open-settings" class="settings-btn">
        <i class="fas fa-cog"></i>
    </button>
</div>

<style>
.reader-container {
    position: relative;
    height: 100vh;
    overflow: hidden;
    background-color: #fff;
}

.book-content {
    height: 100%;
    overflow-y: auto;
    padding: 20px;
    transition: background-color 0.3s, color 0.3s;
}

.content-wrapper {
    max-width: 800px;
    margin: 0 auto;
    padding: 20px 0;
}

.page {
    display: none;
    font-size: 16px;
    line-height: 1.6;
    margin-bottom: 20px;
}

.page.active-page {
    display: block;
}

/* Темы */
.white-theme {
    background-color: #fff;
    color: #000;
}

.sepia-theme {
    background-color: #f4ecd8;
    color: #5b4636;
}

.gray-theme {
    background-color: #e6e6e6;
    color: #333;
}

.black-theme {
    background-color: #121212;
    color: #e0e0e0;
}

/* Панель настроек */
.settings-panel {
    position: fixed;
    top: 0;
    right: -350px;
    width: 320px;
    height: 100%;
    background-color: #fff;
    box-shadow: -2px 0 10px rgba(0,0,0,0.1);
    padding: 20px;
    z-index: 1000;
    transition: right 0.3s;
    overflow-y: auto;
}

.settings-panel.show {
    right: 0;
}

.settings-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    padding-bottom: 10px;
    border-bottom: 1px solid #eee;
}

.settings-section {
    margin-bottom: 25px;
}

.settings-section h6 {
    font-weight: 600;
    margin-bottom: 15px;
    color: #555;
}

.settings-option {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
}

.theme-selector {
    display: flex;
    gap: 10px;
}

.theme-btn {
    width: 30px;
    height: 30px;
    border-radius: 50%;
    border: 2px solid #ddd;
    cursor: pointer;
    padding: 0;
}

.theme-btn.active {
    border-color: #4a79a7;
}

.theme-btn.white {
    background-color: #fff;
}

.theme-btn.sepia {
    background-color: #f4ecd8;
}

.theme-btn.gray {
    background-color: #e6e6e6;
}

.theme-btn.black {
    background-color: #121212;
}

.font-size-controls {
    display: flex;
    align-items: center;
    gap: 10px;
}

.font-size-value {
    min-width: 40px;
    text-align: center;
}

.settings-btn {
    position: fixed;
    bottom: 20px;
    right: 20px;
    width: 50px;
    height: 50px;
    border-radius: 50%;
    background-color: #4a79a7;
    color: white;
    border: none;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    z-index: 999;
    box-shadow: 0 2px 10px rgba(0,0,0,0.2);
}

/* Адаптация для мобильных */
@media (max-width: 768px) {
    .book-content {
        padding: 15px;
    }

    .content-wrapper {
        padding: 10px 0;
    }

    .settings-panel {
        width: 280px;
    }

    .settings-btn {
        width: 40px;
        height: 40px;
        font-size: 16px;
    }
}

@media (max-width: 480px) {
    .settings-panel {
        width: 100%;
        right: -100%;
    }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const bookContent = document.getElementById('book-content');
    const settingsPanel = document.getElementById('settings-panel');
    const openSettingsBtn = document.getElementById('open-settings');
    const closeSettingsBtn = document.getElementById('close-settings');
    const themeButtons = document.querySelectorAll('.theme-btn');
    const brightnessSlider = document.querySelector('.brightness-slider');
    const fontSelect = document.querySelector('.font-select');
    const decreaseFontBtn = document.querySelector('.decrease-font');
    const increaseFontBtn = document.querySelector('.increase-font');
    const fontSizeValue = document.querySelector('.font-size-value');
    const scrollModeSwitch = document.getElementById('scroll-mode');
    const pages = document.querySelectorAll('.page');

    let currentFontSize = 16;

    // Открытие/закрытие панели настроек
    openSettingsBtn.addEventListener('click', function() {
        settingsPanel.classList.add('show');
    });

    closeSettingsBtn.addEventListener('click', function() {
        settingsPanel.classList.remove('show');
    });

    // Смена темы
    themeButtons.forEach(button => {
        button.addEventListener('click', function() {
            themeButtons.forEach(btn => btn.classList.remove('active'));
            this.classList.add('active');

            // Удаляем все классы тем
            bookContent.classList.remove('white-theme', 'sepia-theme', 'gray-theme', 'black-theme');

            // Добавляем выбранную тему
            const theme = this.dataset.theme;
            bookContent.classList.add(`${theme}-theme`);

            // Сохраняем в localStorage
            localStorage.setItem('readerTheme', theme);
        });
    });

    // Яркость
    brightnessSlider.addEventListener('input', function() {
        const brightness = this.value;
        bookContent.style.filter = `brightness(${brightness}%)`;
        localStorage.setItem('readerBrightness', brightness);
    });

    // Шрифт
    fontSelect.addEventListener('change', function() {
        bookContent.style.fontFamily = this.value;
        localStorage.setItem('readerFont', this.value);
    });

    // Размер шрифта
    decreaseFontBtn.addEventListener('click', function() {
        if (currentFontSize > 12) {
            currentFontSize--;
            updateFontSize();
        }
    });

    increaseFontBtn.addEventListener('click', function() {
        if (currentFontSize < 24) {
            currentFontSize++;
            updateFontSize();
        }
    });

    function updateFontSize() {
        bookContent.style.fontSize = `${currentFontSize}px`;
        fontSizeValue.textContent = `${currentFontSize}px`;
        localStorage.setItem('readerFontSize', currentFontSize);
    }

    // Режим прокрутки
    scrollModeSwitch.addEventListener('change', function() {
        if (this.checked) {
            enableScrollMode();
        } else {
            disableScrollMode();
        }
        localStorage.setItem('readerScrollMode', this.checked);
    });

    function enableScrollMode() {
        pages.forEach(page => page.style.display = 'block');
        bookContent.style.overflowY = 'auto';
    }

    function disableScrollMode() {
        const activePage = document.querySelector('.page.active-page');
        pages.forEach(page => {
            if (page !== activePage) {
                page.style.display = 'none';
            }
        });
        bookContent.style.overflowY = 'hidden';
    }

    // Загрузка сохраненных настроек
    function loadSettings() {
        // Тема
        const savedTheme = localStorage.getItem('readerTheme') || 'white';
        document.querySelector(`.theme-btn.${savedTheme}`).click();

        // Яркость
        const savedBrightness = localStorage.getItem('readerBrightness') || 100;
        brightnessSlider.value = savedBrightness;
        bookContent.style.filter = `brightness(${savedBrightness}%)`;

        // Шрифт
        const savedFont = localStorage.getItem('readerFont') || 'Arial';
        fontSelect.value = savedFont;
        bookContent.style.fontFamily = savedFont;

        // Размер шрифта
        const savedFontSize = localStorage.getItem('readerFontSize') || 16;
        currentFontSize = parseInt(savedFontSize);
        updateFontSize();

        // Режим прокрутки
        const savedScrollMode = localStorage.getItem('readerScrollMode') !== 'false';
        scrollModeSwitch.checked = savedScrollMode;
        if (savedScrollMode) {
            enableScrollMode();
        } else {
            disableScrollMode();
        }
    }

    // Инициализация
    loadSettings();

    // Обработка свайпов для перелистывания (если режим прокрутки выключен)
    let touchStartX = 0;
    let touchEndX = 0;

    bookContent.addEventListener('touchstart', function(e) {
        touchStartX = e.changedTouches[0].screenX;
    }, false);

    bookContent.addEventListener('touchend', function(e) {
        if (scrollModeSwitch.checked) return;

        touchEndX = e.changedTouches[0].screenX;
        handleSwipe();
    }, false);

    function handleSwipe() {
        if (Math.abs(touchEndX - touchStartX) < 50) return;

        if (touchEndX < touchStartX) {
            // Свайп влево - следующая страница
            nextPage();
        } else {
            // Свайп вправо - предыдущая страница
            prevPage();
        }
    }

    function nextPage() {
        const activePage = document.querySelector('.page.active-page');
        const nextPage = activePage.nextElementSibling;

        if (nextPage && nextPage.classList.contains('page')) {
            activePage.classList.remove('active-page');
            nextPage.classList.add('active-page');
            nextPage.scrollIntoView();
        }
    }

    function prevPage() {
        const activePage = document.querySelector('.page.active-page');
        const prevPage = activePage.previousElementSibling;

        if (prevPage && prevPage.classList.contains('page')) {
            activePage.classList.remove('active-page');
            prevPage.classList.add('active-page');
            prevPage.scrollIntoView();
        }
    }
});
</script>
{% endblock %}